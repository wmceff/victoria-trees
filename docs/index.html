<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style type="text/css">
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
<body>
  <div id="map"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-marker-clusterer/1.0.0/markerclusterer.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0lUZaV1OxuFUzdFbhTvihC8SeUDkxqf8&callback=initMap"></script>
  <script>
    let openInfoWindow;
    let markers = [];

    const fetchTrees = function(pos) {
      let params = '';
      if (pos) {
        const radius = .001 // very roughly 1km around current position
        params = `?xmin=${pos.lng + radius}&xmax=${pos.lng - radius}&ymin=${pos.lat-radius}&ymax=${pos.lat+radius}`
      }

      const treesEndpoint = 'https://5s7vu0rlq6.execute-api.ca-central-1.amazonaws.com/production/trees'+params;

      fetch(treesEndpoint).then(function(response) {
        return response.json();
      }).then(function(response) {
        const trees = response; // .slice(0, 10);

        trees.forEach(function(feature) {
          const lat = feature.latitude;
          const lng = feature.longitude;
          const commonName = feature.common_name;

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            title: commonName,
            icon: 'http://maps.google.com/mapfiles/kml/shapes/parks.png'
          });

          // info window is 250px  on an iphone6 - 12px margin
          // could probably do soemthing better with window size
          // content: '<div style="height:500px;width:238px;margin:0;padding:0"><a href="https://en.m.wikipedia.org/?title='+feature.attributes.Species+'" target="_blank">'+feature.attributes.CommonName+'</a></div>'
          let infoWindow = new google.maps.InfoWindow({
            content: `
              <div style='margin:10px;padding:10px'>
                <h1>${feature.common_name}</h1>
                <a href='https://en.m.wikipedia.org/?title=${feature.botanical_name}' target='_blank'>${feature.botanical_name}</a>
              </div>
            `
          });

          marker.addListener('click', function() {
            if (openInfoWindow) {
              openInfoWindow.close();
            };
            infoWindow.open(map, marker);
            openInfoWindow = infoWindow;
          });

          markers.push(marker);

        });

        const markerCluster = new MarkerClusterer(map, markers, { imagePath: 'images/m', gridSize: 80 });
      });
    };

    var map;
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 48.413489, lng: -123.363524},
        zoom: 18,
        mapTypeId: google.maps.MapTypeId.SATELLITE,
        tilt: 0
      });

      function RefreshButton(controlDiv, map) {
        const buttonText = 'Relocate';

        // Set CSS for the control border.
        const controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '10px';
        controlUI.style.textAlign = 'center';
        controlUI.title = buttonText;
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        const controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = buttonText;
        controlUI.appendChild(controlText);

        controlUI.addEventListener('click', function() {
          centerOnCurrentLocationAndFetch();
        });
      } // centerControl

      // Create the DIV to hold the control and call the CenterControl()
      // constructor passing in this DIV.
      const centerControlDiv = document.createElement('div');
      const refreshButton = new RefreshButton(centerControlDiv, map);

      centerControlDiv.index = 1;
      map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(centerControlDiv);

      function centerOnCurrentLocationAndFetch() {
        // remove all markers
        markers.forEach((marker, index) => {
          marker.setMap(null);
        });
        markers = [];

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            map.setCenter(pos);
            map.setZoom(21);
            const marker = new google.maps.Marker({
              position: pos,
              map: map,
              title: 'You are here'
            });

            fetchTrees(pos);
          }, function() {
            alert('Had a problem finding your location - refresh and try again');
          });
        } else {
          fetchTrees();
        }
      }

      centerOnCurrentLocationAndFetch();
    } // initMap
  </script>
</body>
</html>
